<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Train Food Quotation System</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --header-yellow: #ffeb3b;
      --border-gray: #333;
      --table-bg: #fff;
      --primary-color: #2196F3;
      --danger-color: #f44336;
      --success-color: #4CAF50;
      --purple-color: #9C27B0;
      --orange-color: #FF9800;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      background: #f3f3f3;
      padding: 15px;
      margin: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      color: #333;
      line-height: 1.6;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 15px;
    }

    .header {
      text-align: center;
      margin-bottom: 20px;
      padding: 15px;
      background: linear-gradient(135deg, var(--primary-color), #0d47a1);
      color: white;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }

    .header h1 {
      margin: 0;
      font-size: 28px;
    }

    .header p {
      margin-top: 8px;
      font-size: 16px;
    }

    .control-panel {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }

    .control-section {
      background: #e3f2fd;
      padding: 15px;
      border-radius: 8px;
      border-left: 5px solid var(--primary-color);
    }

    .control-section h3 {
      margin-top: 0;
      color: #0d47a1;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .input-group {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
    }

    .input-group label {
      flex: 1;
      font-weight: bold;
    }

    .input-group input {
      padding: 8px 12px;
      border: 1px solid #ccc;
      border-radius: 4px;
      width: 100px;
      font-family: inherit;
    }

    .gst-slider-container {
      margin-top: 10px;
    }

    .gst-slider {
      width: 100%;
      height: 8px;
      -webkit-appearance: none;
      background: #ddd;
      outline: none;
      border-radius: 4px;
    }

    .gst-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: var(--primary-color);
      cursor: pointer;
    }

    .toolbar {
      display: flex;
      gap: 12px;
      margin-bottom: 20px;
      flex-wrap: wrap;
      justify-content: center;
    }

    button {
      padding: 12px 20px;
      border-radius: 6px;
      border: none;
      color: white;
      font-weight: bold;
      cursor: pointer;
      font-size: 16px;
      transition: all 0.3s;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      display: flex;
      align-items: center;
      gap: 8px;
      font-family: inherit;
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }

    #downloadPng {
      background: var(--success-color);
    }

    #downloadPdf {
      background: #FF9800;
    }

    #clearAll {
      background: var(--danger-color);
    }

    #saveData {
      background: var(--purple-color);
    }

    #toggleTrainNo {
      background: #607D8B;
    }

    #addRow {
      background: var(--primary-color);
    }

    #toggleAdvance {
      background: #795548;
    }

    #capture {
      width: 1400px;
      margin: 0 auto;
    }

    .calc-info {
      background: #e3f2fd;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      border-left: 5px solid var(--primary-color);
    }

    /* Card area */
    .quote-card {
      background: var(--table-bg);
      border: 2px solid var(--border-gray);
      box-shadow: 0 6px 15px rgba(0,0,0,0.1);
      padding: 20px;
      overflow-x: auto;
      border-radius: 10px;
    }

    table.quotation {
      border-collapse: collapse;
      width: 100%;
      min-width: 600px;
      table-layout: auto;
    }

    table.quotation th, table.quotation td {
      border: 1px solid var(--border-gray);
      padding: 15px;
      vertical-align: top;
      font-size: 16px;
      font-family: inherit;
    }

    table.quotation th {
      background: var(--header-yellow);
      font-weight: bold;
      text-align: left;
    }

    .editable {
      min-height: 24px;
      word-break: break-word;
      transition: background-color 0.3s;
      font-family: inherit;
      font-size: inherit;
    }

    .editable:focus {
      outline: 2px dashed var(--primary-color);
      background-color: #f5f5f5;
    }

    .calc-cell {
      background-color: #f1f8e9;
      font-weight: bold;
    }

    .summary-table {
      margin-top: 25px;
      border-collapse: collapse;
      width: 100%;
      max-width: 500px;
      margin-left: auto;
    }

    .summary-table td {
      border: 1px solid var(--border-gray);
      padding: 15px;
      font-family: inherit;
    }

    .summary-table .yellow {
      background: var(--header-yellow);
      font-weight: bold;
    }

    .remaining-amount {
      background-color: #ffcccc;
      color: #cc0000;
      font-weight: bold;
    }

    .footer {
      text-align: center;
      margin-top: 25px;
      color: #666;
      font-size: 14px;
    }

    .storage-status {
      text-align: center;
      margin-top: 10px;
      font-size: 14px;
      color: #666;
    }

    .hidden {
      display: none;
    }

    .remove-row {
      color: var(--danger-color);
      cursor: pointer;
      text-align: center;
      font-size: 18px;
    }

    .remove-row:hover {
      color: #d32f2f;
    }

    /* Responsive adjustments */
    @media (max-width: 992px) {
      table.quotation th, table.quotation td {
        padding: 12px;
        font-size: 15px;
      }
    }

    @media (max-width: 768px) {
      body {
        padding: 10px;
      }
      
      .container {
        padding: 10px;
      }
      
      .header h1 {
        font-size: 24px;
      }
      
      .header p {
        font-size: 14px;
      }
      
      .quote-card {
        padding: 15px;
      }
      
      table.quotation th, table.quotation td {
        padding: 10px;
        font-size: 14px;
      }
      
      button {
        padding: 10px 15px;
        font-size: 14px;
      }
      
      .control-panel {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 576px) {
      .toolbar {
        flex-direction: column;
        align-items: stretch;
      }
      
      button {
        width: 100%;
        margin-bottom: 8px;
        justify-content: center;
      }
      
      .header h1 {
        font-size: 20px;
      }
      
      .input-group {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .input-group input {
        width: 100%;
        margin-top: 5px;
      }
    }

    @media print {
      body { 
        padding: 0; 
        background: white;
      }
      .toolbar, .control-panel, .calc-info { 
        display: none; 
      }
      .quote-card {
        box-shadow: none;
        border: 1px solid #000;
      }
    }
  </style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1>Train Food Quotation System</h1>
    <p>Create and download quotations for train food services</p>
  </div>

  <div class="control-panel">
    <div class="control-section">
      <h3><i class="fas fa-file-signature"></i> File Settings</h3>
      <div class="input-group">
        <label for="filename">File Name:</label>
        <input type="text" id="filename" placeholder="Enter filename" value="Train_Quotation">
      </div>
    </div>
    
    <div class="control-section">
      <h3><i class="fas fa-percent"></i> GST Settings</h3>
      <div class="input-group">
        <label for="gstPercentage">GST Percentage:</label>
        <input type="number" id="gstPercentage" min="0" max="30" step="0.1" value="5">
      </div>
      <div class="gst-slider-container">
        <input type="range" id="gstSlider" class="gst-slider" min="0" max="30" step="0.1" value="5">
      </div>
    </div>

    <div class="control-section">
      <h3><i class="fas fa-money-bill-wave"></i> Advance Payment</h3>
      <div class="input-group">
        <label for="advanceInput">Advance Amount:</label>
        <input type="number" id="advanceInput" min="0" step="0.01" value="0">
      </div>
      <button id="applyAdvance"><i class="fas fa-check-circle"></i> Apply Advance</button>
    </div>
  </div>

  <div class="toolbar">
    <button id="addRow"><i class="fas fa-plus-circle"></i> Add Row</button>
    <button id="downloadPng"><i class="fas fa-download"></i> Download PNG</button>
    <button id="downloadPdf"><i class="fas fa-file-pdf"></i> Download PDF</button>
    <button id="toggleTrainNo"><i class="fas fa-eye-slash"></i> Toggle Train No</button>
    <button id="toggleAdvance"><i class="fas fa-money-bill-wave"></i> Toggle Advance Section</button>
    <button id="clearAll"><i class="fas fa-trash"></i> Clear All</button>
    <button id="saveData"><i class="fas fa-save"></i> Save Data</button>
  </div>

  <div class="calc-info">
    <strong>Calculation Info:</strong> Total Amount = Unit Pax × Unit Amount | GST = <span id="gstDisplay">5</span>% of Total Amount | Final Amount = Total Amount + GST - Advance Amount
    <br>
    <strong>Auto-Save:</strong> Data is automatically saved to your browser's local storage.
  </div>

  <div id="capture" class="quote-card">
    <table class="quotation">
      <colgroup>
        <col style="width: 5%">
        <col style="width: 10%">
        <col style="width: 10%" id="trainNoColumn">
        <col style="width: 15%">
        <col style="width: 10%">
        <col style="width: 25%">
        <col style="width: 10%">
        <col style="width: 10%">
        <col style="width: 10%">
      </colgroup>
      <thead>
        <tr>
          <th></th>
          <th>Date</th>
          <th class="train-no-header">Train no</th>
          <th>Location</th>
          <th>Time</th>
          <th>Menu</th>
          <th>Unit Pax</th>
          <th>Unit Amount</th>
          <th>Total amount</th>
        </tr>
      </thead>
      <tbody id="items-table-body">
        <!-- Rows will be added dynamically -->
      </tbody>
    </table>

    <table class="summary-table">
      <tbody>
        <tr>
          <td class="yellow">Total amount</td>
          <td id="subtotal-amount">0.00</td>
        </tr>
        <tr>
          <td class="yellow">Gst amount <span id="gst-percentage-label">5</span>%</td>
          <td id="gst-amount">0.00</td>
        </tr>
        <tr>
          <td class="yellow">Grand amount</td>
          <td id="final-amount">0.00</td>
        </tr>
        <tr id="advance-section">
          <td class="yellow">Advance amount</td>
          <td id="advance-display">0.00</td>
        </tr>
        <tr id="remaining-section">
          <td class="yellow">Remaining amount</td>
          <td id="remaining-amount" class="remaining-amount">0.00</td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="storage-status" id="storageStatus">
    Data saved to local storage. It will be available when you return.
  </div>

  <div class="footer">
    <p>© 2023 Train Quotation System | Automatically calculates totals and saves your data</p>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
  // Get DOM elements
  const captureEl = document.getElementById('capture');
  const filenameInput = document.getElementById('filename');
  const gstPercentageInput = document.getElementById('gstPercentage');
  const gstSlider = document.getElementById('gstSlider');
  const gstDisplay = document.getElementById('gstDisplay');
  const gstPercentageLabel = document.getElementById('gst-percentage-label');
  const storageStatus = document.getElementById('storageStatus');
  const toggleTrainNoBtn = document.getElementById('toggleTrainNo');
  const toggleAdvanceBtn = document.getElementById('toggleAdvance');
  const applyAdvanceBtn = document.getElementById('applyAdvance');
  const advanceInput = document.getElementById('advanceInput');
  const tableBody = document.getElementById('items-table-body');
  const addRowBtn = document.getElementById('addRow');
  
  const subtotalAmountEl = document.getElementById('subtotal-amount');
  const gstAmountEl = document.getElementById('gst-amount');
  const finalAmountEl = document.getElementById('final-amount');
  const advanceDisplayEl = document.getElementById('advance-display');
  const remainingAmountEl = document.getElementById('remaining-amount');
  const advanceSection = document.getElementById('advance-section');
  const remainingSection = document.getElementById('remaining-section');
  
  let isTrainNoVisible = true;
  let isAdvanceSectionVisible = true;
  let rowCount = 0;
  let totalAdvance = 0;

  // Create new row
  function createNewRow() {
    rowCount++;
    const row = document.createElement('tr');
    row.id = `row-${rowCount}`;
    row.innerHTML = `
      <td class="remove-row" onclick="removeRow(${rowCount})"><i class="fas fa-times-circle"></i></td>
      <td class="editable" contenteditable="true">17-09-2025</td>
      <td class="editable train-no-cell" contenteditable="true"></td>
      <td class="editable" contenteditable="true"></td>
      <td class="editable" contenteditable="true"></td>
      <td class="editable" contenteditable="true"></td>
      <td class="editable calc-input" contenteditable="true" data-calculation="pax">0</td>
      <td class="editable calc-input" contenteditable="true" data-calculation="amount">0</td>
      <td class="calc-cell row-total">0.00</td>
    `;

    const paxInput = row.querySelector('[data-calculation="pax"]');
    const amountInput = row.querySelector('[data-calculation="amount"]');

    paxInput.addEventListener('input', calculateRowTotal);
    amountInput.addEventListener('input', calculateRowTotal);

    paxInput.addEventListener('focus', clearIfZero);
    amountInput.addEventListener('focus', clearIfZero);

    const editables = row.querySelectorAll('.editable');
    editables.forEach(editable => {
      editable.addEventListener('paste', function(e) {
        e.preventDefault();
        const text = (e.clipboardData || window.clipboardData).getData('text/plain');
        document.execCommand('insertText', false, text);
      });
      editable.addEventListener('input', saveToLocalStorage);
    });

    return row;
  }

  function removeRow(rowId) {
    const row = document.getElementById(`row-${rowId}`);
    if (row && tableBody.children.length > 1) {
      row.remove();
      calculateAllTotals();
      saveToLocalStorage();
    } else {
      alert("You need at least one row.");
    }
  }

  function clearIfZero(e) {
    if (e.target.textContent.trim() === '0') {
      e.target.textContent = '';
    }
  }

  function calculateRowTotal() {
    const row = this.closest('tr');
    const paxCell = row.querySelector('[data-calculation="pax"]');
    const amountCell = row.querySelector('[data-calculation="amount"]');
    const totalCell = row.querySelector('.row-total');

    const pax = parseFloat(paxCell.textContent) || 0;
    const amount = parseFloat(amountCell.textContent) || 0;

    totalCell.textContent = (pax * amount).toFixed(2);

    calculateAllTotals();
  }

  function rowTotalsAmount() {
    let subtotal = 0;
    document.querySelectorAll('.row-total').forEach(cell => {
      subtotal += parseFloat(cell.textContent) || 0;
    });
    return subtotal;
  }

  function calculateAllTotals() {
    const subtotal = rowTotalsAmount();
    const gstPercentage = parseFloat(gstPercentageInput.value) || 0;
    const gstAmount = subtotal * (gstPercentage / 100);
    const grandTotal = subtotal + gstAmount;
    const remainingAmount = grandTotal - totalAdvance;

    subtotalAmountEl.textContent = subtotal.toFixed(2);
    gstAmountEl.textContent = gstAmount.toFixed(2);
    finalAmountEl.textContent = grandTotal.toFixed(2);
    advanceDisplayEl.textContent = totalAdvance.toFixed(2);
    remainingAmountEl.textContent = remainingAmount.toFixed(2);

    saveToLocalStorage();
  }

  function applyAdvanceAmount() {
    totalAdvance = parseFloat(advanceInput.value) || 0;
    calculateAllTotals();
  }

  function toggleAdvanceSection() {
    isAdvanceSectionVisible = !isAdvanceSectionVisible;
    
    if (isAdvanceSectionVisible) {
      advanceSection.style.display = 'table-row';
      remainingSection.style.display = 'table-row';
      toggleAdvanceBtn.innerHTML = '<i class="fas fa-money-bill-wave"></i> Hide Advance Section';
    } else {
      advanceSection.style.display = 'none';
      remainingSection.style.display = 'none';
      toggleAdvanceBtn.innerHTML = '<i class="fas fa-money-bill-wave"></i> Show Advance Section';
    }
    
    saveToLocalStorage();
  }

  function saveToLocalStorage() {
    const rows = [];
    tableBody.querySelectorAll('tr').forEach(row => {
      const cells = row.querySelectorAll('.editable');
      rows.push({
        date: cells[0].textContent,
        trainNo: cells[1].textContent,
        location: cells[2].textContent,
        time: cells[3].textContent,
        menu: cells[4].textContent,
        unitPax: cells[5].textContent,
        unitAmount: cells[6].textContent
      });
    });

    const data = {
      rows: rows,
      filename: filenameInput.value,
      gstPercentage: gstPercentageInput.value,
      isTrainNoVisible: isTrainNoVisible,
      isAdvanceSectionVisible: isAdvanceSectionVisible,
      totalAdvance: totalAdvance
    };

    localStorage.setItem('trainQuotationData', JSON.stringify(data));

    storageStatus.textContent = 'Data saved at ' + new Date().toLocaleTimeString();
    storageStatus.style.color = '#4CAF50';
    setTimeout(() => { storageStatus.style.color = '#666'; }, 3000);
  }

  function loadFromLocalStorage() {
    const savedData = localStorage.getItem('trainQuotationData');
    if (savedData) {
      const data = JSON.parse(savedData);

      tableBody.innerHTML = '';
      rowCount = 0;

      if (data.rows && data.rows.length > 0) {
        data.rows.forEach(rowData => {
          const newRow = createNewRow();
          const cells = newRow.querySelectorAll('.editable');
          cells[0].textContent = rowData.date || '';
          cells[1].textContent = rowData.trainNo || '';
          cells[2].textContent = rowData.location || '';
          cells[3].textContent = rowData.time || '';
          cells[4].textContent = rowData.menu || '';
          cells[5].textContent = rowData.unitPax || '';
          cells[6].textContent = rowData.unitAmount || '';
          tableBody.appendChild(newRow);
        });
      } else {
        tableBody.appendChild(createNewRow());
      }

      filenameInput.value = data.filename || 'Train_Quotation';
      gstPercentageInput.value = data.gstPercentage || '5';
      gstSlider.value = data.gstPercentage || '5';
      updateGstDisplay();

      isTrainNoVisible = data.hasOwnProperty('isTrainNoVisible') ? data.isTrainNoVisible : true;
      toggleTrainNoColumn(isTrainNoVisible);

      isAdvanceSectionVisible = data.hasOwnProperty('isAdvanceSectionVisible') ? data.isAdvanceSectionVisible : true;
      toggleAdvanceSectionDisplay(isAdvanceSectionVisible);

      totalAdvance = data.totalAdvance || 0;
      advanceInput.value = totalAdvance;

      calculateAllTotals();
    } else {
      tableBody.appendChild(createNewRow());
    }
  }

  function updateGstDisplay() {
    gstDisplay.textContent = gstPercentageInput.value;
    gstPercentageLabel.textContent = gstPercentageInput.value;
  }

  function toggleTrainNoColumn(visible) {
    const headers = document.querySelectorAll('.train-no-header');
    const cells = document.querySelectorAll('.train-no-cell');
    const col = document.getElementById('trainNoColumn');

    if (visible) {
      headers.forEach(h => h.classList.remove('hidden'));
      cells.forEach(c => c.classList.remove('hidden'));
      col.style.display = 'table-column';
      toggleTrainNoBtn.innerHTML = '<i class="fas fa-eye-slash"></i> Hide Train No';
    } else {
      headers.forEach(h => h.classList.add('hidden'));
      cells.forEach(c => c.classList.add('hidden'));
      col.style.display = 'none';
      toggleTrainNoBtn.innerHTML = '<i class="fas fa-eye"></i> Show Train No';
    }
    isTrainNoVisible = visible;
    saveToLocalStorage();
  }

  function toggleAdvanceSectionDisplay(visible) {
    if (visible) {
      advanceSection.style.display = 'table-row';
      remainingSection.style.display = 'table-row';
      toggleAdvanceBtn.innerHTML = '<i class="fas fa-money-bill-wave"></i> Hide Advance Section';
    } else {
      advanceSection.style.display = 'none';
      remainingSection.style.display = 'none';
      toggleAdvanceBtn.innerHTML = '<i class="fas fa-money-bill-wave"></i> Show Advance Section';
    }
    isAdvanceSectionVisible = visible;
  }

  function clearAllInputs() {
    tableBody.innerHTML = '';
    tableBody.appendChild(createNewRow());
    totalAdvance = 0;
    advanceInput.value = '0';
    filenameInput.value = 'Train_Quotation';
    gstPercentageInput.value = '5';
    gstSlider.value = '5';
    updateGstDisplay();
    calculateAllTotals();
    saveToLocalStorage();
  }

  // Download PNG with custom filename
  async function downloadPNG() {
    try {
      const canvas = await html2canvas(captureEl, {
        scale: 3,
        useCORS: true,
        logging: false
      });
      const link = document.createElement('a');
      link.href = canvas.toDataURL('image/png');
      link.download = filenameInput.value + '.png';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    } catch (error) {
      console.error('Error generating PNG:', error);
      alert('Error generating PNG. Please try again.');
    }
  }

  // Download PDF with custom filename
  async function downloadPDF() {
    try {
      const { jsPDF } = window.jspdf;
      const canvas = await html2canvas(captureEl, {
        scale: 3,
        useCORS: true,
        logging: false
      });
      
      const imgData = canvas.toDataURL('image/png');
      const imgWidth = 210; // A4 width in mm
      const imgHeight = (canvas.height * imgWidth) / canvas.width;
      
      const pdf = new jsPDF('p', 'mm', 'a4');
      pdf.addImage(imgData, 'PNG', 0, 0, imgWidth, imgHeight);
      pdf.save(filenameInput.value + '.pdf');
    } catch (error) {
      console.error('Error generating PDF:', error);
      alert('Error generating PDF. Please try again.');
    }
  }

  function setupEventListeners() {
    gstPercentageInput.addEventListener('input', () => {
      gstSlider.value = gstPercentageInput.value;
      updateGstDisplay();
      calculateAllTotals();
    });

    gstSlider.addEventListener('input', () => {
      gstPercentageInput.value = gstSlider.value;
      updateGstDisplay();
      calculateAllTotals();
    });

    filenameInput.addEventListener('input', saveToLocalStorage);
    advanceInput.addEventListener('input', saveToLocalStorage);

    applyAdvanceBtn.addEventListener('click', applyAdvanceAmount);
    
    toggleTrainNoBtn.addEventListener('click', () => {
      toggleTrainNoColumn(!isTrainNoVisible);
    });

    toggleAdvanceBtn.addEventListener('click', () => {
      toggleAdvanceSection();
    });

    document.getElementById('clearAll').addEventListener('click', clearAllInputs);
    document.getElementById('addRow').addEventListener('click', () => {
      tableBody.appendChild(createNewRow());
      calculateAllTotals();
    });

    document.getElementById('downloadPng').addEventListener('click', downloadPNG);
    document.getElementById('downloadPdf').addEventListener('click', downloadPDF);
  }

  window.addEventListener('load', () => {
    loadFromLocalStorage();
    setupEventListeners();
  });
</script>

</body>
</html>
